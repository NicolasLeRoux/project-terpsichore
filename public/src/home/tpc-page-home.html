<!--
Page ...
-->
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../../bower_components/app-layout/app-scroll-effects/effects/waterfall.html">
<link rel="import" href="../../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../../bower_components/paper-progress/paper-progress.html">

<dom-module id="tpc-page-home">

	<template>
		<style>
			app-toolbar {
				background-color: #f7f7f7;
			}

			paper-progress {
				width: 100%;
			}

			.events {
				padding-top: 10px;
				background-color: #EEE;
			}

			.events h4 {
				margin: 10px;
			}

			.events-list {
				border-top: 1px solid rgba(0, 0, 0, 0.12);
				border-bottom: 1px solid rgba(0, 0, 0, 0.12);
				background-color: white;
				list-style-type: none;
				padding: 0;
				margin: 0;
			}

			.event-item a {
				text-decoration: none;
				color: black;
			}

			.event-item-content {
				margin: 0 10px;
			}

			.event-item:not(:first-child) {
				border-top: 1px solid rgba(0, 0, 0, 0.12);

			}
		</style>

		<app-header-layout>
			<app-header reveals condenses effects="waterfall">
				<app-toolbar>
					<div>
						<h1>Page home</h1>
					</div>
				</app-toolbar>
				<paper-progress indeterminate></paper-progress>
			</app-header>
			<div class="events">
				<h4>Mardi 9 mai</h4>
				<ul class="events-list">
					<template is="dom-repeat"
						items="{{events}}"
						as="event">
						<li class="event-item">
							<a href="/event/{{event.$key}}">
								<div class="event-item-content">
									<p>{{event.organizer}}</p>
									<h3>{{event.title}}</h3>
								</div>
							</a>
						</li>
					</template>
				</ul>
			</div>
		</app-header-layout>

	</template>

	<script>
		Polymer({
			is: 'tpc-page-home',

			properties: {
				firebaseApp: {
					type: Object,
					notify: false
				},
				rawEvents: {
					type: Object,
					notify: true,
					observer: '_rawEventsChanged'
				},
				events: {
					type: Object,
					notify: true
				}
			},

			ready: function() {
				this.queryDatabase();
			},

			queryDatabase: function () {
				var xhr = new XMLHttpRequest(),
					url = app.databaseURL + '/events.json',
					params = {
						orderBy: '\"sortKey\"',
						startAt: '201705071930',
						limitToFirst: 10
					};

				// En attente de mieux
				url += '?orderBy=' + params.orderBy;
				url += '&startAt=' + params.startAt;
				url += '&limitToFirst=' + params.limitToFirst;

				xhr.onreadystatechange = this.onProcessRequest.bind(this, xhr);
				xhr.open("GET", url, true);
				xhr.send();
			},

			onProcessRequest: function (xhr, event) {
				var response;

				if (xhr.readyState === 4 && xhr.status === 200) {
					response = JSON.parse(xhr.responseText);

					if (response) {
						this.rawEvents = response;
					}
				}
			},

			_rawEventsChanged: function (data) {
				this.events = Object.keys(data).map(function (key) {
					var event = data[key];
					event.$key = key;

					return event;
				});
			}
		});
	</script>
</dom-module>
